<!DOCTYPE html>
<html>
    <head>
        <title>INFO 3300 - Project 2 (rcc263, jmw555)</title>
        
        <!-- <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Raleway:400,700" rel="stylesheet"> -->

        
        <!-- <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/default.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js"></script> -->
        <script src="https://d3js.org/d3.v6.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>
        
        <style>
        .nation {
            fill: #ddd;
        }
        
        .outline {
            stroke: #fff;
            stroke-width: 1px;
            fill: none;
        }
        </style>
    </head>

    <body>
        <svg id="choropleth" height="610" width="975" style="background: #fff; margin:50px"></svg>
        <svg id="graph" height="610" width="975"></svg>
        
        <script>
            const svg = d3.select("#choropleth");
            const mapwidth = svg.attr("width");
            const mapheight = svg.attr("height");
            const map = svg.append("g");

            const requestData = async function() {

                const mlb = await d3.csv("/datasets/MLB.csv");
                let nba = await d3.csv("/datasets/NBA.csv");
                const nfl = await d3.csv("/datasets/NFL.csv");
                let nhl = await d3.csv("/datasets/NHL.csv");

                const population = await d3.csv("/datasets/population.csv");


                //data filtering & manipulation here
                population.forEach( (d) => {
                    d['2019 Population'] = Number(d['2019 Population']);
                });

                nhl = nhl.filter((d) => { return d["To"]==="2021"})
                mlb.forEach( (d) => {
                    d['Count'] = Number(d['Count']);
                    d["State"] = String(d['State']).trim()
                });
                nba.forEach( (d) => {
                    if (d['State'] === "DC") {
                        d["State"] = "District of Columbia";
                    } else { 
                        words = String(d['State']).trim().toLowerCase().split(" ");
                        cleanedString =""
                        words.forEach( (word) => {
                            cleanedString += (word[0].toUpperCase() + word.substr(1) + " ");
                        })
                        cleanedString = cleanedString.trim();
                        d["State"] = cleanedString;
                    }
                });
                nfl.forEach( (d) => {
                    if (d['STATE'] === "D.C.") {
                        d['STATE'] = "District of Columbia"
                    }
                    // d['COUNT'] = Number(d['COUNT']);

                })

                //choropleth setup

                const us = await d3.json("/datasets/counties-10m.json");
                var projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
                var path = d3.geoPath().projection(projection);

                var nation = topojson.feature(us, us.objects.nation);
                var states = topojson.feature(us, us.objects.states);
                var statesMesh = topojson.mesh(us, us.objects.states);

                map.selectAll("path.nation").data(nation.features)
                .join("path")
                .attr("class", "nation")
                .attr("d", path)

                map.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path)


                function mapStates(league) {
                    var states = league.map(row => row["State"]);
                    // console.log(states);
                    var league_obj = {};

                    states.forEach(state => {
                        if (league_obj[state]) {
                            league_obj[state]++;
                        } else {
                            league_obj[state] = 1;
                        }
                    });
                    // console.log(league_obj);

                    var league = [];

                    for (let state in league_obj) {
                        league.push({"State": state, "Count": league_obj[state]});
                    }
                    
                    return league;
                }
                nba = mapStates(nba);
                nhl = mapStates(nhl);


                //mapping data to states
                states.features.forEach( (state) => {
                    name = state.properties.name;

                    population.forEach( (d) => {
                        if ((d['State'] === name)) {
                            state.properties['Population'] = d['2019 Population']
                        }
                    });

                    state.properties["Total Count"] = 0;
                    found = false;

                    nba.forEach( (d) => {
                        if ((d['State'] === name) && !found) {
                            state.properties['NBA'] = d['Count']
                            state.properties["Total Count"] += d['Count'];
                            found = true;
                        }
                    });
                    if (!found){
                        state.properties['NBA'] = 0;
                    }

                    found = false;
                    mlb.forEach( (d) => {
                        if ((d['State'] === name) && !found) {
                            state.properties['MLB'] = d['Count']
                            state.properties["Total Count"] += d['Count'];
                            found = true;
                        }
                    });
                    if (!found){
                        state.properties['MLB'] = 0;
                    }

                    found = false;
                    nfl.forEach( (d) => {
                        if ((d['STATE'] === name) && !found) {
                            state.properties['NFL'] = d['Count']
                            state.properties["Total Count"] += d['Count'];
                            found = true;
                        }
                    });
                    if (!found){
                        state.properties['NFL'] = 0;
                    }

                    found = false;
                    nhl.forEach( (d) => {
                        if ((d['State'] === name) && !found) {
                            state.properties['NHL'] = d['Count']
                            state.properties["Total Count"] += d['Count'];
                            found = true;
                        }
                    });
                    if (!found){
                        state.properties['NHL'] = 0;
                    }

                });
                console.log("States:", states);
                console.log("NBA", nba);
                console.log("NBA", nba);
                console.log("NBA", nba);
                console.log("NBA", nba);


                function getExtents(data) {
                    const countExtent = d3.extent(data, d => d['Count']);
                    console.log(data, countExtent);
                }
                
                getExtents(nba);
                getExtents(mlb);
                getExtents(nhl);
                getExtents("nfl",nfl);
                
                // let diverityScale = d3.scaleQuantile().domain(nyb.Total_Biodiversity_allvalues).range(colors);



                // state coloring
                // map.selectAll("path").data(states.features)
                // .join("path")
                // .attr('class', 'health')
                // .attr("d", path) 
                // .attr("fill", idk we'll figure this out later)


                map.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path)
            }
            requestData();

        </script>
    
    </body>
</html>
