<!DOCTYPE html>
<html>
    <head>
        <title>INFO 3300 - Project 2 (rcc263, jmw555)</title>
        
        <link rel="stylesheet" href="style.css">

        <script src="https://d3js.org/d3.v6.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>
        
    </head>

    <body>
        <div id="leagues"></div>
        <div id="toggle"></div>
        <svg id="choropleth" height="610" width="975"></svg>
        <svg id = "colorScale" height = "100", width = "900"></svg>
        <svg id="graph" height="610" width="975"></svg>
        
        <script>
            const svg = d3.select("#choropleth");
            const mapwidth = svg.attr("width");
            const mapheight = svg.attr("height");
            const map = svg.append("g");

            const requestData = async function() {

                const mlb = await d3.csv("datasets/MLB.csv");
                let nba = await d3.csv("datasets/NBA.csv");
                const nfl = await d3.csv("datasets/NFL.csv");
                let nhl = await d3.csv("datasets/NHL.csv");

                const population = await d3.csv("/datasets/population.csv");


                //data filtering & manipulation here
                population.forEach( (d) => {
                    d['2019 Population'] = Number(d['2019 Population']);
                });

                nhl = nhl.filter((d) => { return d["To"]==="2021"})

                mlb.forEach( (d) => {
                    d['Count'] = Number(d['Count']);
                    d["State"] = String(d['State']).trim()
                });

                nba = nba.filter((d) => { return d["To"]==="2021"})
                nba.forEach( (d) => {
                    if (d['State'] === "DC") {
                        d["State"] = "District of Columbia";
                    } else { 
                        words = String(d['State']).trim().toLowerCase().split(" ");
                        cleanedString =""
                        words.forEach( (word) => {
                            cleanedString += (word[0].toUpperCase() + word.substr(1) + " ");
                        })
                        cleanedString = cleanedString.trim();
                        d["State"] = cleanedString;
                    }
                });

                nfl.forEach( (d) => {
                    if (d['State'] === "D.C.") {
                        d['State'] = "District of Columbia"
                    }
                    d['Count'] = Number(d['Count']);

                })

                //choropleth setup

                const us = await d3.json("/datasets/counties-10m.json");
                var projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
                var path = d3.geoPath().projection(projection);

                var nation = topojson.feature(us, us.objects.nation);
                var states = topojson.feature(us, us.objects.states);
                var statesMesh = topojson.mesh(us, us.objects.states);

                map.selectAll("path.nation").data(nation.features)
                .join("path")
                .attr("class", "nation")
                .attr("d", path)

                map.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path)


                function mapStates(league) {
                    var states = league.map(row => row["State"]);
                    // console.log(states);
                    var league_obj = {};

                    states.forEach(state => {
                        if (league_obj[state]) {
                            league_obj[state]++;
                        } else {
                            league_obj[state] = 1;
                        }
                    });
                    // console.log(league_obj);

                    var league = [];

                    for (let state in league_obj) {
                        league.push({"State": state, "Count": league_obj[state]});
                    }
                    
                    return league;
                }
                nba = mapStates(nba);
                nhl = mapStates(nhl);

                //mapping data to states
                totalCounts = []

                nbaProportions = [];
                mlbProportions = [];
                nflProportions = [];
                nhlProportions = [];
                totalProportions = [];

                function assignCounts(state, name, league, data){
                    found = false;

                    data.forEach( (d) => {
                        if ((d['State'] === name) && !found) {
                            state.properties[league] = d['Count']
                            state.properties["Total Count"] += d['Count'];
                            found = true;
                        }
                    });
                    if (!found){
                        state.properties[league] = 0;
                    }
                    totalCounts.push(state.properties["Total Count"])

                    
                }

                datasets = [nba, mlb, nfl, nhl]
                leagues = ["NBA", "MLB", "NFL", "NHL"]

                states.features.forEach( (state) => {
                    name = state.properties.name;

                    population.forEach( (d) => {
                        if ((d['State'] === name)) {
                            state.properties['Population'] = d['2019 Population']
                            
                        }
                    });

                    state.properties["Total Count"] = 0;

                    for (i=0;i<datasets.length;i++){
                        assignCounts(state, name, leagues[i], datasets[i])
                        state.properties[String(leagues[i] + ' Proportion')] = 100 * state.properties[leagues[i]]/state.properties["Population"]
                    }
                    state.properties["Total Proportion"] = 100 * state.properties["Total Count"]/state.properties["Population"]
                    totalProportions.push(100 * state.properties["Total Count"]/state.properties["Population"])
                    nbaProportions.push(100 * state.properties["NBA"]/state.properties["Population"])
                    mlbProportions.push(100 * state.properties["MLB"]/state.properties["Population"])
                    nflProportions.push(100 * state.properties["NFL"]/state.properties["Population"])
                    nhlProportions.push(100 * state.properties["NHL"]/state.properties["Population"])



                });
                console.log("States:", states);
                // console.log("NBA", nba);
                // console.log("NFL", nfl);
                // console.log("NBA", nba);
                // console.log("NBA", nba);
                
                nbaExtent = d3.extent(nba, d => d['Count']);
                mlbExtent = d3.extent(mlb, d => d['Count']);
                nflExtent = d3.extent(nfl, d => d['Count']);
                nhlExtent = d3.extent(nhl, d => d['Count']);
                totalExtent = d3.extent(totalCounts)

                // populationExtent
                // console.log(nflExtent)

                let nbaProportionExtent = d3.extent(nbaProportions);
                let mlbProportionExtent = d3.extent(mlbProportions);
                let nflProportionExtent = d3.extent(nflProportions);
                let nhlProportionExtent = d3.extent(nhlProportions);
                let totalProportionExtent = d3.extent(totalProportions)
                
                let totalScale = d3.scaleLinear().domain(totalExtent).range(['lightgrey', 'darkgreen'])
                let nbaScale = d3.scaleLinear().domain(nbaExtent).range(['lightgrey', 'darkorange'])
                let mlbScale = d3.scaleLinear().domain(mlbExtent).range(['lightgrey', 'darkred'])
                let nflScale = d3.scaleLinear().domain(nflExtent).range(['lightgrey', 'brown'])
                let nhlScale = d3.scaleLinear().domain(nhlExtent).range(['lightgrey', 'darkblue'])

                let totalProportionScale = d3.scaleLinear().domain(totalProportionExtent).range(['lightgrey', 'darkgreen'])
                let nbaProportionScale = d3.scaleLinear().domain(nbaProportionExtent).range(['lightgrey', 'darkorange'])
                let mlbProportionScale = d3.scaleLinear().domain(mlbProportionExtent).range(['lightgrey', 'darkred'])
                let nflProportionScale = d3.scaleLinear().domain(nflProportionExtent).range(['lightgrey', 'brown'])
                let nhlProportionScale = d3.scaleLinear().domain(nhlProportionExtent).range(['lightgrey', 'darkblue'])


                // state coloring for total counts -- DO NOT DELETE
                map.selectAll("path").data(states.features)
                .join("path")
                // .attr('class', 'total')
                .attr("d", path) 
                .attr("fill", d => totalScale(d.properties['Total Count']))

                // map.selectAll("path").data(states.features)
                // .join("path")
                // .attr('class', 'mlb')
                // .attr("d", path) 
                // .attr("fill", d => nbaScale(d.properties['NBA']))


                map.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path)

                let pcts = false;

                const logos = ["images/nba.png", "images/mlb.png", "images/nfl.svg", "images/nhl.png", "Total"];
                logos.forEach( d => {
                    if (d !== 'Total') {
                        if (d === 'images/nba.png' ) {
                            d3.select("div#leagues")
                            .append("button")
                                .attr("class", "league")
                                .attr("width", "100")
                                .attr("height", "50")
                                .on("click", function(){
                                    updateMap(d);
                                })
                            .append("img")
                                .attr("src", d)
                                .attr("alt", d)
                                .attr("x", "60")
                                .attr("y", "60")
                                .attr("width", "70")
                                .attr("height", "40")

                        } else {
                            d3.select("div#leagues")
                            .append("button")
                            .attr("class", "league")
                            .attr("width", "100")
                            .attr("height", "50")
                            .attr("league", d)
                            .on("click", function(){
                                updateMap(d);
                            })
                            .append("img")
                            .attr("src", d)
                            .attr("alt", d)
                            .attr("x", "60")
                            .attr("y", "60")
                            .attr("width", "40")
                            .attr("height", "40");
                        }
                    } else {
                        d3.select("div#leagues")
                        .append("button")
                        .attr("class", "league")
                        .text( d )
                        .style("font-size", "1.7em")
                        .attr("width", "30")
                        .attr("height", "30")
                        .on("click", function(){
                            updateMap(d);
                        });
                    }
                    
                    // .on("click", function() {
                    // })
                });
                d3.select("div#toggle")
                    .append("button")
                    .attr('class', 'toggleButton')
                    .attr('id', 'countButton')
                    .text("Counts")
                    .attr("width", "30")
                    .attr("height", "30")
                    .on("click", function(){
                        map.selectAll("path").data(states.features)
                            // .transition(25)
                            .attr("fill", d => totalScale(d.properties['Total Count']));
                        d3.select("button#countButton").transition(100).style("background-color", 'lightgrey').style("font-weight", "bold")
                        d3.select("button#pctButton").transition(100).style("background-color", 'white').style("font-weight", "normal").style("color", "black")

                        pcts = false;
                    });

                d3.select("div#toggle")
                    .append("button")
                    .attr('class', 'toggleButton')
                    .attr('id', 'pctButton')
                    .text("Percentages")
                    .attr("width", "30")
                    .attr("height", "30")
                    .on("click", function(){
                        map.selectAll("path").data(states.features)
                            // .attr("d", path) 
                            // .transition(25)
                            .attr("fill", d => totalProportionScale(d.properties['Total Proportion']))

                        d3.select("button#countButton").transition(100).style("background-color", 'white').style("font-weight", "normal")
                        d3.select("button#pctButton").transition(100).style("background-color", 'lightgrey').style("font-weight", "bold")

                        pcts = true;
                    });

                

                function updateMap(d) {
                    const pctDict = {"images/nba.png": nbaProportionScale, "images/mlb.png": mlbProportionScale, "images/nfl.svg": nflProportionScale, "images/nhl.png": nhlProportionScale, "Total": totalProportionScale};
                    const countDict = {"images/nba.png": nbaScale, "images/mlb.png": mlbScale, "images/nfl.svg": nflScale, "images/nhl.png": nhlScale, "Total": totalScale};

                    proportionDict = {"images/nba.png": 'NBA Proportion', "images/mlb.png": 'MLB Proportion', "images/nfl.svg": 'NFL Proportion', "images/nhl.png": 'NHL Proportion', "Total": 'Total Proportion'};
                    leagueDict = {"images/nba.png": 'NBA', "images/mlb.png": 'MLB', "images/nfl.svg": 'NFL', "images/nhl.png": 'NHL', "Total": 'Total Count'};

                    console.log(d);
                    console.log(leagueDict[d]);


                    if (pcts) {
                        map.selectAll("path").data(states.features)
                        .attr("fill", s => pctDict[d](s.properties[proportionDict[d]]));
                    } else {
                        map.selectAll("path").data(states.features)
                            .attr("fill", s => countDict[d](s.properties[leagueDict[d]]));
                    }

                    // console.log(d);

                    // if (d === "images/mlb.png") {
                    //     if (pcts) {
                    //         map.selectAll("path").data(states.features)
                    //         // .transition(25)
                    //         .attr("fill", d => mlbProportionScale(d.properties['MLB Proportion']));
                    //     } else {
                    //         map.selectAll("path").data(states.features)
                    //             // .transition(25)
                    //             .attr("fill", d => mlbScale(d.properties['MLB']));
                    //     }
                    // } else if (d === "images/nfl.svg") {
                    //     if (pcts) {
                    //         map.selectAll("path").data(states.features)
                    //         // .transition(25)
                    //         .attr("fill", d => nflProportionScale(d.properties['NFL Proportion']));
                    //     } else {
                    //         map.selectAll("path").data(states.features)
                    //             // .transition(25)
                    //             .attr("fill", d => nflScale(d.properties['NFL']));
                    //     }
                    // } else if (d === "images/nhl.png") {
                    //     if (pcts) {
                    //         map.selectAll("path").data(states.features)
                    //         // .transition(25)
                    //         .attr("fill", d => nhlProportionScale(d.properties['NHL Proportion']));
                    //     } else {
                    //         map.selectAll("path").data(states.features)
                    //             // .transition(25)
                    //             .attr("fill", d => nhlScale(d.properties['NHL']));
                    //     }
                    // }

                }

                
            }
            requestData();

        </script>
    
    </body>
</html>
