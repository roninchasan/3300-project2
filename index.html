<!DOCTYPE html>
<html>
    <head>
        <title>INFO 3300 - Project 2 (rcc263, jmw555)</title>
        
        <link rel="stylesheet" href="style.css">

        <script src="https://d3js.org/d3.v6.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>
        
    </head>

    <body>
        <div id="leagues"></div>
        <svg id="choropleth" height="610" width="975"></svg>
        <svg id = "colorScale" height = "100", width = "900"></svg>
        <svg id="graph" height="610" width="975"></svg>
        
        <script>
            const svg = d3.select("#choropleth");
            const mapwidth = svg.attr("width");
            const mapheight = svg.attr("height");
            const map = svg.append("g");

            const requestData = async function() {

                const mlb = await d3.csv("datasets/MLB.csv");
                let nba = await d3.csv("datasets/NBA.csv");
                const nfl = await d3.csv("datasets/NFL.csv");
                let nhl = await d3.csv("datasets/NHL.csv");

                const population = await d3.csv("/datasets/population.csv");


                //data filtering & manipulation here
                population.forEach( (d) => {
                    d['2019 Population'] = Number(d['2019 Population']);
                });

                nhl = nhl.filter((d) => { return d["To"]==="2021"})

                mlb.forEach( (d) => {
                    d['Count'] = Number(d['Count']);
                    d["State"] = String(d['State']).trim()
                });

                nba = nba.filter((d) => { return d["To"]==="2021"})
                nba.forEach( (d) => {
                    if (d['State'] === "DC") {
                        d["State"] = "District of Columbia";
                    } else { 
                        words = String(d['State']).trim().toLowerCase().split(" ");
                        cleanedString =""
                        words.forEach( (word) => {
                            cleanedString += (word[0].toUpperCase() + word.substr(1) + " ");
                        })
                        cleanedString = cleanedString.trim();
                        d["State"] = cleanedString;
                    }
                });

                nfl.forEach( (d) => {
                    if (d['State'] === "D.C.") {
                        d['State'] = "District of Columbia"
                    }
                    d['Count'] = Number(d['Count']);

                })

                //choropleth setup

                const us = await d3.json("/datasets/counties-10m.json");
                var projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
                var path = d3.geoPath().projection(projection);

                var nation = topojson.feature(us, us.objects.nation);
                var states = topojson.feature(us, us.objects.states);
                var statesMesh = topojson.mesh(us, us.objects.states);

                map.selectAll("path.nation").data(nation.features)
                .join("path")
                .attr("class", "nation")
                .attr("d", path)

                map.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path)


                function mapStates(league) {
                    var states = league.map(row => row["State"]);
                    // console.log(states);
                    var league_obj = {};

                    states.forEach(state => {
                        if (league_obj[state]) {
                            league_obj[state]++;
                        } else {
                            league_obj[state] = 1;
                        }
                    });
                    // console.log(league_obj);

                    var league = [];

                    for (let state in league_obj) {
                        league.push({"State": state, "Count": league_obj[state]});
                    }
                    
                    return league;
                }
                nba = mapStates(nba);
                nhl = mapStates(nhl);

                //mapping data to states
                totalCounts = []

                function assignCounts(state, name, league, data){
                    found = false;

                    data.forEach( (d) => {
                        if ((d['State'] === name) && !found) {
                            state.properties[league] = d['Count']
                            state.properties["Total Count"] += d['Count'];
                            found = true;
                        }
                    });
                    if (!found){
                        state.properties[league] = 0;
                    }
                    totalCounts.push(state.properties["Total Count"])
                }

                datasets = [nba, mlb, nfl, nhl]
                leagues = ["NBA", "MLB", "NFL", "NHL"]

                states.features.forEach( (state) => {
                    name = state.properties.name;

                    population.forEach( (d) => {
                        if ((d['State'] === name)) {
                            state.properties['Population'] = d['2019 Population']
                        }
                    });

                    state.properties["Total Count"] = 0;

                    for (i=0;i<datasets.length;i++){
                        assignCounts(state, name, leagues[i], datasets[i])
                    }

                });
                console.log("States:", states);
                // console.log("NBA", nba);
                console.log("NFL", nfl);
                // console.log("NBA", nba);
                // console.log("NBA", nba);
                
                nbaExtent = d3.extent(nba, d => d['Count']);
                mlbExtent = d3.extent(mlb, d => d['Count']);
                nflExtent = d3.extent(nfl, d => d['Count']);
                nhlExtent = d3.extent(nhl, d => d['Count']);
                totalExtent = d3.extent(totalCounts)
                // console.log(nflExtent)
                
                let totalScale = d3.scaleLinear().domain(totalExtent).range(['lightgrey', 'darkgreen'])
                let nbaScale = d3.scaleLinear().domain(nbaExtent).range(['lightgrey', 'darkorange'])
                let mlbScale = d3.scaleLinear().domain(mlbExtent).range(['lightgrey', 'darkred'])
                let nflScale = d3.scaleLinear().domain(nflExtent).range(['lightgrey', 'brown'])
                let nhlScale = d3.scaleLinear().domain(nhlExtent).range(['lightgrey', 'darkblue'])



                // state coloring for total counts -- DO NOT DELETE
                map.selectAll("path").data(states.features)
                .join("path")
                // .attr('class', 'total')
                .attr("d", path) 
                .attr("fill", d => totalScale(d.properties['Total Count']))

                // map.selectAll("path").data(states.features)
                // .join("path")
                // .attr('class', 'mlb')
                // .attr("d", path) 
                // .attr("fill", d => nbaScale(d.properties['NBA']))


                map.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path)

                // drawLegend(d3.select("#colorLegend"), totalScale)
            }
            requestData();

        </script>
    
    </body>
</html>
